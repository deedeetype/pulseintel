# 2026-02-25 - PulseIntel Development Session

## üéØ Major Feature Completed: Automated Scan Scheduling

### Database Schema (Supabase)
- Created table: `scan_schedules` with migration `003_scan_schedules.sql`
- Fields: frequency (daily/weekly/monthly), day_of_week, day_of_month, hour, minute, timezone
- Auto-calculated `next_run_at` via PostgreSQL trigger function `calculate_next_run()`
- RLS policies: **Temporarily permissive (`USING (true)`)** for testing
  - ‚ö†Ô∏è TODO: Secure RLS policies after Stripe integration with proper user table

### Backend - Netlify Scheduled Function
- Created: `/netlify/functions/scheduled-scans.mts`
- Cron schedule: `0 * * * *` (every hour)
- Logic: Fetches due schedules, calls scan-step for refresh, updates last_run_at
- **STATUS: Not yet deployed** - Getting 404, needs redeploy verification

### Frontend - Settings UI
- Component: `AutomatedScansSettings.tsx`
- Tab added to SettingsView: "Automated Scans"
- Per-profile scheduling with toggle ON/OFF
- Selectors: Frequency, Day (contextual), Hour (0-23), Timezone (8 options)
- Shows last_run_at and next_run_at timestamps
- **Working:** Save schedule creates entry in scan_schedules table

## üêõ Issues Resolved

### user_id Mismatch (Critical)
- **Problem:** Frontend using Clerk user_id (`user_2xxx...`) vs backend using DEMO_USER_ID
- **Solution:** Dashboard now passes Clerk `user?.id` to scan-step init
- **Result:** New scans created with proper Clerk user_id

### RLS Policy Blocking (Critical)
- **Problem:** Supabase RLS policies using `auth.uid()` blocked client queries
- **Temporary Fix:** Set policies to `USING (true)` for both scans and scan_schedules tables
- **TODO:** Create proper users table mapping clerk_user_id ‚Üí Supabase auth.uid()
- **Architecture needed:**
  ```sql
  CREATE TABLE users (
    id UUID PRIMARY KEY,
    clerk_user_id TEXT UNIQUE NOT NULL
  );
  ```

### scheduled-scans Function Not Deployed
- **Problem:** 404 on function endpoint
- **Cause:** Function file exists locally but not detected by Netlify build
- **Next Step:** Force redeploy or verify Netlify function detection

## üìä Current State

### Working Features
- ‚úÖ Manual scan creation with proper user_id
- ‚úÖ Automated scan schedule creation via UI
- ‚úÖ Schedule saved to scan_schedules table
- ‚úÖ next_run_at auto-calculated by trigger
- ‚úÖ Settings UI shows profiles and schedule config

### Pending
- ‚è≥ scheduled-scans function deployment verification
- ‚è≥ Test actual automated refresh execution
- ‚è≥ Verify new alerts/insights generation on refresh

## üîñ Restore Point Created
- Tag: `v1.0-stable` (commit 1da0c49)
- Document: `RESTORE_POINTS.md`
- Status: All features working before automated scans implementation

## üìù Technical Notes

### Supabase Query Pattern (Client-Side)
```typescript
// With permissive RLS, queries work directly:
const { data } = await supabase
  .from('scans')
  .select('*')
  .eq('user_id', userId)
  .eq('status', 'completed')
```

### Testing Scheduled Function
```sql
-- Force immediate trigger:
UPDATE scan_schedules 
SET next_run_at = NOW() - INTERVAL '10 minutes'
WHERE enabled = true;

-- Then invoke function manually
```

### Console Debugging
```javascript
[AutomatedScans] Fetching scans for user: user_3AAiF7VzUvqc24pSYpuT6SIhWhf
[AutomatedScans] Found scans: 1
[AutomatedScans] Saving schedule for scan: xxx user: xxx
```

## üéØ Next Steps (Session End)
1. Force Netlify redeploy for scheduled-scans function
2. Test function invocation (curl or Netlify UI)
3. Verify refresh creates new alerts/insights
4. Move to next feature: Export PDF reports or Email notifications
5. Eventually: Stripe integration + proper user table + secure RLS

## üíæ Data Integrity Notes
- User cleaned all Supabase tables and Clerk users to start fresh
- Current test user: `user_3AAiF7VzUvqc24pSYpuT6SIhWhf`
- Test scan: Automotive industry (scan_id: 57555616-8558-4f36-8dfd-cc1997b9ee95)
- Schedule created successfully with daily frequency at 18:00 EST

---

## üéâ BREAKTHROUGH: Automated Scans WORKING (16:50 EST)

### The Solution: Next.js Scheduled API Routes
After many attempts with Netlify Functions, discovered the correct approach:
- **Path:** `pages/api/cron/refresh-scans.ts` (NOT netlify/functions/)
- **Config:** `export const config = { type: 'experimental-scheduled', schedule: '0 * * * *' }`
- **Key:** Must use `.mts` extension for TypeScript modules
- **Format:** `export default async (req: Request) => { ... }`

### Why Previous Attempts Failed
1. ‚ùå Netlify Functions with `schedule` export don't work with @netlify/plugin-nextjs
2. ‚ùå `.ts` extension wasn't detected as scheduled
3. ‚ùå `export const handler` instead of `export default`
4. ‚úÖ Next.js Scheduled API Routes are the ONLY way for Next.js + Netlify

### Proof of Success
- Last automated run: 2026-02-25 16:50 EST
- Generated 5 new insights successfully:
  1. Freight Market Volatility (threat)
  2. Sustainability as Differentiator (recommendation)
  3. AI-Driven Autonomous Logistics (trend)
  4. Nearshoring Creating New Demand (opportunity)
  5. Sustainability as Operational Imperative (recommendation)
- `refresh_count` incremented correctly
- `last_run_at` and `next_run_at` updated automatically

---

## ‚ú® Activity Logging Implementation (17:09 - 17:28 EST)

### New Feature: Refresh History & Activity Logs

**Database Table:** `refresh_logs`
```sql
CREATE TABLE refresh_logs (
  id UUID PRIMARY KEY,
  scan_id UUID REFERENCES scans(id),
  user_id TEXT,
  triggered_by TEXT, -- 'manual' | 'scheduled'
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  status TEXT, -- 'success' | 'failed' | 'running'
  new_alerts_count INT,
  new_insights_count INT,
  new_news_count INT,
  error_message TEXT
);
```

**Backend Logging** (`pages/api/cron/refresh-scans.ts`)
- Creates log entry at start of each refresh
- Tracks counts: new_alerts, new_insights, new_news
- Updates status: running ‚Üí success/failed
- Logs error_message on failure
- triggered_by: 'scheduled' for automated runs

**UI Components:**
1. **ProfileCard Badge** (`ProfilesView.tsx`)
   - Shows "Auto-refreshed 2h ago"
   - Displays counts: "5 insights, 3 alerts"
   - Uses Lucide icons: Clock, TrendingUp (no emojis)
   - Only for successful scheduled refreshes

2. **Activity Page** (new sidebar tab)
   - Component: `ActivityView.tsx`
   - Shows last 50 refresh logs
   - Status indicators: CheckCircle, XCircle, RefreshCw
   - Badges: "Automated" vs "Manual"
   - Time formatting: "2 hours ago"
   - Empty state for no activity

---

## üîÑ Migration to GitHub Actions (18:23 - 19:39 EST)

### Problem: Next.js experimental-scheduled Unreliable
Despite being documented, `experimental-scheduled` didn't trigger automatically.
Functions appeared in Netlify but never executed on schedule.

### Solution: GitHub Actions Workflow (Industry Standard)

**Workflow:** `.github/workflows/scheduled-refresh.yml`
```yaml
on:
  schedule:
    - cron: '0 * * * *'  # Every hour UTC
  workflow_dispatch:  # Manual trigger for testing
```

**Security:** CRON_SECRET header
- Generated: `689fdfd52875dee3fbd89346a46d23befc802a88f90f4324cb19f4bbca791c3a`
- Added to GitHub Secrets
- Added to Netlify environment variables
- Function validates `X-Cron-Secret` header before executing

**Advantages:**
- ‚úÖ 100% reliable (GitHub infrastructure)
- ‚úÖ Visible logs in GitHub Actions
- ‚úÖ Manual trigger for testing
- ‚úÖ Free (included with GitHub)
- ‚úÖ Industry standard for Next.js + Netlify

### Setup Process
1. Created workflow file
2. Added CRON_SECRET to GitHub repository secrets
3. Added CRON_SECRET to Netlify environment variables
4. Removed `experimental-scheduled` config
5. Deleted old netlify/functions/scheduled-scans.mts

### Testing
- Manual workflow trigger: ‚úÖ Success
- `last_run_at` updates: ‚úÖ Working
- GitHub Actions logs: ‚úÖ Visible
- HTTP Status: 200 ‚úÖ

---

## üêõ Current Issue: refresh_logs Not Populating (19:39 EST)

### Symptoms
- GitHub Actions workflow succeeds (HTTP 200)
- `last_run_at` updates in scan_schedules ‚úÖ
- `next_run_at` recalculates correctly ‚úÖ
- **BUT:** No rows in `refresh_logs` table ‚ùå

### Investigation
- Response shows: `"total":1,"successful":0,"failed":1`
- Indicates refresh **executed** but **failed**
- Log creation happens AFTER fetching scans
- Error occurs before creating initial log entry

### Possible Causes
1. Error in scan-step function call (URL/credentials)
2. Timeout during news/analyze steps
3. Missing environment variables in cron context
4. RLS policy blocking log writes

### Next Steps
- Check Netlify Function logs around execution time
- Add debug logging at each step
- Verify environment variables available in API route
- Test manual refresh to compare behavior

---

## üìö Key Learnings

### Netlify + Next.js Scheduled Jobs
- **‚ùå DON'T USE:** `netlify/functions/` with schedule export
- **‚ùå DON'T USE:** Next.js `experimental-scheduled` (unreliable)
- **‚úÖ USE:** GitHub Actions ‚Üí POST to Next.js API route
- **‚úÖ Pattern:** External cron service ‚Üí secured HTTP endpoint

### Scheduled Function Debugging
- Netlify scheduled functions don't show in separate UI entries
- Bundled into "Next.js Server Handler"
- Logs may not appear in real-time
- Manual testing via workflow_dispatch essential

### Security Best Practices
- Always use secret header for cron endpoints
- Generate cryptographically secure secrets (openssl rand -hex 32)
- Store in both GitHub Secrets and Netlify environment variables
- Validate secret before processing any cron request

---

## üéØ Status at Session End

### Fully Working
- ‚úÖ Manual scans (competitors, news, alerts, insights)
- ‚úÖ Dashboard with all views
- ‚úÖ Settings UI with schedule configuration
- ‚úÖ Schedule creation and storage
- ‚úÖ GitHub Actions hourly trigger
- ‚úÖ `last_run_at` / `next_run_at` updates
- ‚úÖ Activity page UI (ready for logs)
- ‚úÖ Profile card badges (ready for logs)

### Partially Working
- ‚ö†Ô∏è Automated refresh execution (triggers but fails)
- ‚ö†Ô∏è Refresh logging (log creation fails)

### To Debug
- üîç Why refresh execution fails (check Netlify logs)
- üîç Why no refresh_logs entries created
- üîç Error message from failed refresh

### Architecture Achievements
- Created robust scheduled job system with GitHub Actions
- Built complete activity logging infrastructure
- UI ready to display logs once backend working
- All code uses Lucide icons (no emojis per requirement)

---

## üì¶ Restore Points

### v2.0-automated-scans-working
- Tag: `v2.0-automated-scans-working`
- Commit: `feea8b9`
- Features: Automated scans proven working with Next.js scheduled routes
- Note: Before migration to GitHub Actions

### Current State (uncommitted)
- GitHub Actions workflow implemented
- Activity logging infrastructure complete
- Debugging refresh execution failures

